<html>
<head>
    <link rel="stylesheet" href="leaflet.css"/>
    <link rel="stylesheet" href="leaflet-search.css"/>
    <link rel="stylesheet" href="leaflet-draw.css"/>
    <link rel="stylesheet" href="leaflet.awesome-markers.css">
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">

    <script src="leaflet.js"></script>
    <script src="leaflet-search.js"></script>
    <script src="leaflet.draw.js"></script>
    <script src="jquery-2.0.3.js"></script>
    <script src="underscore.js"></script>
    <script src="layers.js"></script>
    <script src="leaflet.awesome-markers.min.js"></script>
</head>

<body>

<div id="map" style="height:100%;width:100%">
    <div class="leaflet-draw leaflet-control">
        <div class="leaflet-draw-section">
            <div class="leaflet-draw-toolbar leaflet-bar leaflet-draw-toolbar-top">
                <a class="leaflet-draw-draw-marker" href="#" id="school" title="Plot a school"
                   onclick="plot('school')"></a>
                <a class="leaflet-draw-draw-marker" href="#" id="hospital" title="Plot a school"
                   onclick="plot('hospital')"></a>
                <a class="leaflet-draw-draw-marker" href="#" id="subway" title="Plot a school"
                   onclick="plot('subway')"></a>
                <a class="leaflet-draw-draw-marker" href="#" id="toilet" title="Plot a school"
                   onclick="plot('toilet')"></a>
                <a class="leaflet-draw-draw-marker" href="#" id="trafficsignal" title="Plot a school"
                   onclick="plot('trafficsignal')"></a>
                <a class="leaflet-draw-draw-marker" href="#" id="park" title="Plot a school"
                   onclick="plot('park')"></a>
                <a class="leaflet-draw-draw-marker" href="#" id="library" title="Plot a school"
                   onclick="plot('library')"></a>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    var cmAttr = '',
            cmUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png',
            minimal = L.tileLayer(cmUrl, {styleId:22677, attribution:cmAttr}),
            map = L.map('map', {
                center:[13.08, 80.27],
                zoom:10,
                layers:[minimal]
            }),
            baseLayers = {
                CMA:minimal
            };

    overlays = {
        "Schools": schools,
        "Hospitals": hospitals,
        "Subways": subways,
        "Toilets": toilets,
        "Traffic Signals": trafficSignals,
        "Parks": parks,
        "Libraries": libraries
    };

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    function plot(item) {
        source = item;
        var marker = new L.Draw.Marker(map);
        marker.enable();
    }

    map.on('draw:created', function (e) {
        var type = e.layerType,
                layer = e.layer;
        //line - school
        //polygon - hospital

        if (type === 'marker') {
            if(source === 'school')
            {
                $.get('data/schools.json', function(data) {
                   data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});
                });
            }
            else if(source === 'hospital')
            {
                $.get('data/hospitals.json', function(data) {
                    data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});

                });
            }
            else if(source === 'subway')
            {
                $.get('data/subways.json', function(data) {
                    data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});
                });
            }
            else if(source === 'toilet')
            {
                $.get('data/toilets.json', function(data) {
                    data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});
                });
            }
            else if(source === 'trafficsignal')
            {
                $.get('data/trafficsignals.json', function(data) {
                    data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});
                });
            }
            else if(source === 'park')
            {
                $.get('data/parks.json', function(data) {
                    data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});
                });
            }else if(source === 'library')
            {
                $.get('data/libraries.json', function(data) {
                    data.push({"latitude":e.layer._latlng.lat, "longitude":e.layer._latlng.lng});
                });
            }
        }
        drawnItems.addLayer(layer);
    });

    L.control.layers(baseLayers, overlays).addTo(map);

    map.addControl(new L.Control.Search({
        url:'http://nominatim.openstreetmap.org/search?format=json&q={s}',
        jsonpParam:'json_callback',
        propertyName:'display_name',
        propertyLoc:['lat', 'lon'],
        markerLocation:true,
        autoType:false,
        autoCollapse:true,
        minLength:2,
        zoom:10
    }));


</script>
</body>

</html>
